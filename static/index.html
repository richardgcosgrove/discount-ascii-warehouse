<!DOCTYPE html>
<html>
    <head>
        <title>Discount Ascii Warehouse</title>
    </head>
    <body>
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
        <script>
            const ads = [];

            function getAd() {

                function hasAd(num) {
                    return ads.indexOf(num) != -1;
                }

                // for (; i; ++i) {
                    let newAd = Math.floor(ads.length * 0.0005) + Math.floor(Math.random() * 10000);
                    while (hasAd(newAd)) {
                        newAd = Math.floor(ads.length * 0.0005) + Math.floor(Math.random() * 10000);
                    }
                    ads.push(newAd);
                    return newAd;
                // }
            }
            window.getAd = getAd;

        </script>
        <header>
            <h1>Discount Ascii Warehouse</h1>

            <p>Here you're sure to find a bargain on some of the finest ascii available to purchase. Be sure to peruse our selection of ascii faces in an exciting range of sizes and prices.</p>

            <p>But first, a word from our sponsors:</p> <script>
            document.write(`<img class="ad" src="/ad/?r=${window.getAd()}"/>`);
            </script>
        </header>

        <section class="products">
            <script>
                const productHeight = 200;
                const productWidth = 450;
                let itemsLength = 0;
                let adCount = 0;
                let products = [];
                let pending = [];

                function getDocHeight() {
                    var D = document;
                    return Math.max(
                        D.body.scrollHeight, D.documentElement.scrollHeight,
                        D.body.offsetHeight, D.documentElement.offsetHeight,
                        D.body.clientHeight, D.documentElement.clientHeight
                    );
                }

                function getCol() {
                    var D = document;
                    console.log(`${$('.products').width()} / ${(productWidth + 20)}`)
                    return Math.ceil($('.products').width() / (productWidth + 20));
                }

                function pad(n, width, z) {
                    z = z || '0';
                    n = n + '';
                    return n.length >= width ? n : new Array(width - n.length + 1).join(z) + n;
                }

                let lastAd = true;
                let resort = false;

                function addItem(item) {
                    let target = item;

                    if (!resort
                        && products.indexOf(item) !== -1) {
                        return false;
                    }

                    if (pending.indexOf(item) == -1 &&
                        pending.length > 0) {
                        target = pending.splice(0,1);
                        pending.push(item);
                    }

                    if (!lastAd && itemsLength % 20 === 0) {
                        lastAd = true;
                        ++itemsLength;
                        ++adCount;

                        $('.products').append(`<div class="pproduct container" style="width:${productWidth}px; float: left; height: ${productHeight}px; border:5px solid black; margin: 2px; padding: 20px 5px"><img class="ad" src="/ad/?r=${window.getAd()}"/></div>`);
                        pending.push(item);
                    } else {
                        lastAd = false;
                        ++itemsLength;
                        let date = new Date(item.date);
                        let old = Date.now() - date.getTime();

                        //is older than week?
                        if (old > 604800000) {
                            date = `${pad(date.getMonth(),2)}/${pad(date.getDay(),2)}/${pad(date.getFullYear(),4)}`;
                        } else {
                            date = `${Math.floor(old / 86400000)} days ago`;
                        }


                        $('.products').append(
                            `<div class="product container" style="width:${productWidth}px; float: left; height: ${productHeight}px; border:5px solid black; margin: 2px; padding: 20px 5px">
                                <div class="product__face" style="font-size: ${item.size}px; margin-bottom:20px">${item.face}</div>
                                <div class="product__size">size: ${item.size}px</div>
                                <div class="product__price">price: $${(item.price * .01).toFixed(2)}</div>
                                <div class="product__date">date: ${date}</div>
                            </div>`
                        );
                        if (!resort) {
                            products.push(item);
                        } 
                    }
                    return true;
                }

                function addRows(num = 2) {
                    if (pending.length > 0) {
                        const col = getCol();
                        const length = itemsLength % col;
                        const itemsToAdd = (col * num) - length;
                        const oldAdCount = adCount;
                        let i = 0;
                        console.log(`col:${col}`);
                        console.log(`${itemsLength} + ${itemsToAdd} = ${itemsLength + itemsToAdd}`);

                        pending.map(item => {
                            if (i < itemsToAdd) {
                                if (addItem(item)) {
                                    console.log('added');
                                    if (++i > itemsToAdd) {
                                        return;
                                    }

                                    if (lastAd) {
                                        if (addItem(item)) {
                                            console.log('added');
                                            if (++i > itemsToAdd) {
                                                return;
                                            }
                                        }
                                    }
                                }
                            }
                        });

                        pending = pending.slice(itemsToAdd - (1 + (adCount - oldAdCount)));
                    }

                }

                function pendRows(rows = 1) {
                    let length = getCol()*rows-pending.length;
                    if (length < 0) {
                        return;
                    }

                    return $.get(`/api/products?limit=${getCol()*rows-pending.length}&skip=${itemsLength- Math.floor(products.length / 20)}`, function(data) {

                        let json = '['.concat(data.replace(/\n/g,','))
                        json = json.substr(0,json.length - 1);
                        json = json.concat(']');
                        json = JSON.parse(json);

                        $.each(json, function(key,item) {
                            pending.push(item);
                        });
                    }, 'text');
                }

                function isScrolledIntoView(el) {
                    var elemTop = el.getBoundingClientRect().top;
                    var elemBottom = el.getBoundingClientRect().bottom;

                    var isVisible = (elemTop >= 0) && (elemBottom <= window.innerHeight);
                    return isVisible;
                }


                $('body').append(`<div id="end" class="products__end" style="float:left;text-align:center; height: 100px; width:100%" >~ end of catalogue ~</div>`);
                const originalHeight = getDocHeight();
                const originalBody = $('body').height();
                let count=0;
                for (let i=productHeight + 50; i + originalBody < originalHeight; i += productHeight + 50) {
                    ++count;
                }

                pendRows(count+4).then(() => {
                    addRows(count);
                });


                $(document).ready(function() {
                    var win = $(window);

                    // Each time the user scrolls
                    win.scroll(function() {
                        // End of the document reached?
                            addRows();
                            
                            //waits to add new data to pending until UI is done
                            setTimeout(() => {
                                pendRows(2 + (pending.length < 20 ? 4 : 0));
                            })
                        }
                    });
                });
            </script>
        </section>
    </body>
</html>
