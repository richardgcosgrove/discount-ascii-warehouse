<!DOCTYPE html>
<html>
    <head>
        <title>Discount Ascii Warehouse</title>
    </head>
    <body>
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
        <header>
            <h1>Discount Ascii Warehouse</h1>

            <p>Here you're sure to find a bargain on some of the finest ascii available to purchase. Be sure to peruse our selection of ascii faces in an exciting range of sizes and prices.</p>

            <p>But first, a word from our sponsors:</p> <script>document.write('<img class="ad" src="/ad/?r=' + Math.floor(Math.random()*1000) + '"/>');</script>
        </header>

        <section class="products">
            <script>
                const productHeight = 150;
                let products = [];

                function getDocHeight() {
                    var D = document;
                    return Math.max(
                        D.body.scrollHeight, D.documentElement.scrollHeight,
                        D.body.offsetHeight, D.documentElement.offsetHeight,
                        D.body.clientHeight, D.documentElement.clientHeight
                    );
                }

                function addRows(rows = 1) {
                    $.get(`/api/products?limit=${3*rows}`, function(data) {

                        let json = '['.concat(data.replace(/\n/g,','))
                        json = json.substr(0,json.length - 1);
                        json = json.concat(']');
                        json = JSON.parse(json);

                        $.each(json, function(key,item) {
                            products.push(item);
                            if (products.length % 20 === 0) {
                                $('.products').append(`<div class="product container" style="width:500px; float: left;margin: 0px 17px;"><img class="ad" src="/ad/?r=${Math.floor(Math.random()*1000)}"/></div>`);
                            } else {
                                $('.products').append(
                                    `<div class="product container" style="width:500px; float: left; height: ${productHeight}px; border:5px solid black; margin: 2px; padding: 20px 5px">
                                        <div class="product__face" style="font-size: ${item.size}px">${item.face}</div>
                                        <div class="product__size">size: ${item.size}px</div>
                                        <div class="product__price">price: $${(item.price * .01).toFixed(2)}</div>
                                        <div class="product__date">date: ${item.date}</div>
                                    </div>`
                                );
                            }
                        } )
                    }, 'text');
                }


                $('body').append(`<div class="products__end" style="float:left;text-align:center; width:100%" >~ end of catalogue ~</div>`);
                const originalHeight = getDocHeight();
                const originalBody = $('body').height();
                let count=0;
                for (let i=productHeight + 50; i + originalBody < originalHeight; i += productHeight + 50) {
                    ++count;
                }
                addRows(count);
            </script>
        </section>
    </body>
</html>
