<!DOCTYPE html>
<html>
    <head>
        <title>Discount Ascii Warehouse</title>
    </head>
    <body>
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
        <script>
            const ads = [];

            function getAd() {
                let i = 0;
                offset = 0;

                function hasAd(num) {
                    return ads.indexOf(num) != -1;
                }

                // for (; i; ++i) {
                    let newAd = Math.floor(ads.length * 0.0001) + Math.floor(Math.random() * 10000);
                    while (hasAd(newAd)) {
                        newAd = Math.floor(ads.length * 0.0001) + Math.floor(Math.random() * 10000);
                    }
                    ads.push(newAd);
                    return newAd;
                // }
            }
            window.getAd = getAd;

        </script>
        <header>
            <h1>Discount Ascii Warehouse</h1>

            <p>Here you're sure to find a bargain on some of the finest ascii available to purchase. Be sure to peruse our selection of ascii faces in an exciting range of sizes and prices.</p>

            <p>But first, a word from our sponsors:</p> <script>
            document.write(`<img class="ad" src="/ad/?r=${window.getAd()}"/>`);
            </script>
        </header>

        <section class="products">
            <script>
                const productHeight = 170;
                const productWidth = 510;
                let products = [];
                let pending = [];

                function getDocHeight() {
                    var D = document;
                    return Math.max(
                        D.body.scrollHeight, D.documentElement.scrollHeight,
                        D.body.offsetHeight, D.documentElement.offsetHeight,
                        D.body.clientHeight, D.documentElement.clientHeight
                    );
                }

                function getCount() {
                    var D = document;
                    return Math.ceil(Math.max(document.documentElement["clientWidth"], document.body["scrollWidth"], document.documentElement["scrollWidth"], document.body["offsetWidth"], document.documentElement["offsetWidth"]) / (productWidth + 20));
                    return res;
                }

                let lastAd = false;
                let resort = false;

                function addItem(item) {
                    let target = item;

                    if (!resort
                        && products.indexOf(item) !== -1) {
                        return;
                    }

                    if (pending.indexOf(item) == -1 &&
                        pending.length > 0) {
                        target = pending.splice(0,1);
                        pending.push(item);
                    }

                    if (!lastAd && (products.length + 1) % 20 === 0) {
                        lastAd = true;

                        $('.products').append(`<div class="product container" style="width:${productWidth}px; height:${productHeight+30}px; float: left; margin: 12px 12px;"><img class="ad" src="/ad/?r=${window.getAd()}"/></div>`);
                        pending.push(item);
                    } else {
                        lastAd = false;

                        $('.products').append(
                            `<div class="product container" style="width:${productWidth}px; float: left; height: ${productHeight}px; border:5px solid black; margin: 2px; padding: 20px 5px">
                                <div class="product__face" style="font-size: ${item.size}px">${item.face}</div>
                                <div class="product__size">size: ${item.size}px</div>
                                <div class="product__price">price: $${(item.price * .01).toFixed(2)}</div>
                                <div class="product__date">date: ${item.date}</div>
                            </div>`
                        );
                        if (!resort) {
                            products.push(item);
                        } 
                    }
                }

                function addRows(rows = 1) {
                    $.get(`/api/products?limit=${getCount()*rows-pending.length}`, function(data) {
                        if (data.length > 0) {
                        let json = '['.concat(data.replace(/\n/g,','))
                        json = json.substr(0,json.length - 1);
                        json = json.concat(']');
                        json = JSON.parse(json);

                        if (pending.length > 0) {
                            pending.map(item => {
                                addItem(item);
                            });

                            pending = [];
                        }

                        $.each(json, function(key,item) {
                            addItem(item);
                        });

                        }
                    }, 'text');
                }

                function addRow(num = 2) {
                    if (pending.length > 0) {
                        const length = getCount() * num;
                        pending.slice(0,length).map(item => {
                            addItem(item);
                        });

                        pending = pending.slice(length-1);
                    }

                }

                function pendRows(rows = 1) {
                    let length = getCount()*rows-pending.length;
                    if (length < 0) {
                        return;
                    }
                    $.get(`/api/products?limit=${getCount()*rows-pending.length}`, function(data) {

                        let json = '['.concat(data.replace(/\n/g,','))
                        json = json.substr(0,json.length - 1);
                        json = json.concat(']');
                        json = JSON.parse(json);

                        $.each(json, function(key,item) {
                            pending.push(item);
                        });
                    }, 'text');
                }

                function isScrolledIntoView(el) {
                    var elemTop = el.getBoundingClientRect().top;
                    var elemBottom = el.getBoundingClientRect().bottom;

                    var isVisible = (elemTop >= 0) && (elemBottom <= window.innerHeight);
                    return isVisible;
                }


                $('body').append(`<div id="end" class="products__end" style="float:left;text-align:center; height: 100px; width:100%" >~ end of catalogue ~</div>`);
                const originalHeight = getDocHeight();
                const originalBody = $('body').height();
                let count=0;
                for (let i=productHeight + 50; i + originalBody < originalHeight; i += productHeight + 50) {
                    ++count;
                }

                addRows(count);
                pendRows(8);

                $(document).ready(function() {
                    var win = $(window);

                    // Each time the user scrolls
                    win.scroll(function() {
                        // End of the document reached?
                        if ($(document).height() - win.height() == win.scrollTop()) {
                            addRow();
                            setTimeout(() => {
                                pendRows(2);
                                if (pending.length < 20) {
                                    pendRows(4);
                                }
                            })
                        }
                    });
                });
            </script>
        </section>
    </body>
</html>
